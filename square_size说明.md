# square-size 参数详细说明

## 什么是 square-size？

`square-size` 是**棋盘格每个方格的实际物理大小**，单位是**毫米（mm）**。

## 为什么需要这个参数？

在相机标定中，我们需要建立**像素坐标**和**真实世界坐标**之间的对应关系：

1. **像素坐标**：图像中的位置（例如：像素 (640, 480)）
2. **真实世界坐标**：实际物理空间中的位置（例如：距离相机 1 米，高度 0.5 米）

棋盘格提供了已知尺寸的参考对象，让我们可以建立这种对应关系。

## 如何设置 square-size？

### 步骤1：准备棋盘格

你需要一个棋盘格图案，可以：
- **打印**：在 A4 纸上打印棋盘格
- **显示**：在平板电脑或显示器上显示

### 步骤2：测量方格大小

**重要**：必须实际测量棋盘格方格的尺寸！

#### 方法1：使用尺子测量（推荐）

1. 使用直尺或卷尺
2. 测量棋盘格中**一个完整方格**的边长
3. 测量多个方格取平均值（提高精度）

```
示例：
┌─────┬─────┬─────┐
│     │     │     │
│  A  │  B  │  C  │  ← 测量这个方格的边长
│     │     │     │
├─────┼─────┼─────┤
│     │     │     │
│  D  │  E  │  F  │
│     │     │     │
└─────┴─────┴─────┘

测量结果：方格边长 = 25.0 mm
→ square-size = 25.0
```

#### 方法2：计算（如果知道整体尺寸）

如果你知道整个棋盘格的尺寸：

```
square-size = 棋盘格总宽度 / 方格数量（横向）
或
square-size = 棋盘格总高度 / 方格数量（纵向）
```

**示例**：
- 棋盘格总宽度 = 225 mm
- 横向方格数 = 9 个
- square-size = 225 / 9 = 25.0 mm

### 步骤3：在命令中使用

```bash
python camera_calibration.py --square-size 25.0
```

## 常见棋盘格尺寸

### 标准 A4 打印（210mm × 297mm）

如果打印在 A4 纸上，常见配置：

| 棋盘格配置 | 方格数量 | 典型 square-size |
|-----------|---------|-----------------|
| 9×6 内角点 | 8×5 方格 | 20-30 mm |
| 9×7 内角点 | 8×6 方格 | 20-30 mm |
| 10×7 内角点 | 9×6 方格 | 20-30 mm |

**注意**：实际尺寸取决于打印设置和缩放比例，**必须实际测量**！

### 在线生成棋盘格

如果你使用在线工具生成棋盘格（如 OpenCV 的 `cv2.drawChessboardCorners`），通常：
- 默认 square-size = 25.0 mm
- 但打印后可能因缩放而改变，需要重新测量

## square-size 对结果的影响

### ✅ 正确设置的影响

如果 `square-size` 设置正确：
- ✅ 标定精度高
- ✅ 焦距计算准确
- ✅ 后续测量（如高度、距离）准确
- ✅ 两个相机焦距比较有意义

### ❌ 错误设置的影响

如果 `square-size` 设置错误：

#### 1. 影响标定精度

```
错误示例：
实际方格大小 = 25.0 mm
设置 square-size = 20.0 mm  ❌

结果：
- 标定会认为方格比实际小
- 导致焦距计算错误
- 重投影误差可能增大
```

#### 2. 影响焦距计算

焦距的计算依赖于真实世界尺寸：

```
焦距（像素） = (图像中的尺寸（像素） / 真实世界尺寸（mm）) × 传感器尺寸（mm）

如果 square-size 错误：
- 真实世界尺寸错误
- 导致焦距计算错误
```

#### 3. 影响后续测量

如果后续需要测量实际尺寸（如任务2c的高度测量）：

```
高度 = (像素高度 / 焦距) × 距离 × (square-size / 实际方格大小)

如果 square-size 错误：
- 所有基于标定的测量都会错误
- 误差会累积
```

#### 4. 影响两个相机焦距比较

如果两个相机使用不同的 `square-size`（即使实际方格相同）：

```
相机1：square-size = 25.0 mm → 焦距 = 856.32 像素
相机2：square-size = 20.0 mm → 焦距 = 684.26 像素

看起来焦距不同，但实际上是 square-size 设置错误！
```

## 如何验证 square-size 是否正确？

### 方法1：检查重投影误差

标定完成后，查看重投影误差：

```
✓ Camera1 标定完成!
  焦距: 856.32 像素
  重投影误差: 0.2341 像素  ← 这个值应该很小（< 0.5 像素）
```

如果重投影误差很大（> 1.0 像素），可能是：
- square-size 设置错误
- 图像质量差
- 标定图像不足

### 方法2：验证测量结果

标定后，用已知尺寸的物体验证：

1. 测量一个已知尺寸的物体（例如：100mm 的尺子）
2. 用标定后的相机拍摄
3. 使用标定结果计算物体尺寸
4. 对比计算结果和实际尺寸

如果误差很大，可能是 square-size 设置错误。

### 方法3：对比两个相机

如果两个相机使用相同的棋盘格和相同的 square-size：
- 焦距应该非常接近（差异 < 5%）
- 如果差异很大，检查 square-size 是否设置一致

## 实际测量示例

### 示例1：打印的棋盘格

```
步骤：
1. 在 A4 纸上打印 9×6 棋盘格
2. 使用尺子测量一个方格
3. 测量结果：24.5 mm
4. 设置：--square-size 24.5
```

### 示例2：平板显示的棋盘格

```
步骤：
1. 在 10 英寸平板上显示棋盘格
2. 平板分辨率：1920×1200
3. 棋盘格占屏幕宽度：约 800 像素
4. 平板实际宽度：216 mm
5. 方格大小 = (216 / 1920) × (800 / 9) ≈ 10.0 mm
6. 设置：--square-size 10.0
```

**注意**：平板显示时，需要考虑屏幕的物理尺寸和分辨率。

## 最佳实践

### 1. 使用高精度测量工具

- 使用游标卡尺（精度 0.1mm）
- 或使用精确的直尺（精度 0.5mm）

### 2. 多次测量取平均

```
测量1：25.2 mm
测量2：24.8 mm
测量3：25.1 mm
平均值：(25.2 + 24.8 + 25.1) / 3 = 25.03 mm
设置：--square-size 25.03
```

### 3. 测量多个方格

测量不同位置的方格，确保棋盘格打印/显示均匀：

```
方格1：25.0 mm
方格2：25.1 mm
方格3：24.9 mm
平均值：25.0 mm
```

### 4. 记录测量结果

在标定报告中记录：
- 使用的棋盘格类型（打印/显示）
- 实际测量的 square-size
- 测量工具和精度

### 5. 两个相机使用相同值

**重要**：两个相机必须使用**完全相同的 square-size**！

```
正确：
相机1：--square-size 25.0
相机2：--square-size 25.0  ✅

错误：
相机1：--square-size 25.0
相机2：--square-size 24.5  ❌
```

## 常见问题

### Q: 如果我不知道方格大小怎么办？

A: 
1. **必须测量**：没有其他方法可以准确知道
2. 使用尺子测量是最简单的方法
3. 如果无法测量，标定结果会不准确

### Q: 单位必须是毫米吗？

A: 
- 代码中使用的是毫米（mm）
- 你也可以使用厘米（cm），但需要转换：
  ```
  25.0 mm = 2.5 cm
  ```
- 建议统一使用毫米，避免混淆

### Q: 如果打印时缩放了怎么办？

A:
- 打印时如果选择了"适应页面"或缩放，实际尺寸会改变
- **必须重新测量**打印后的实际尺寸
- 不要使用设计时的尺寸，使用实际打印后的尺寸

### Q: square-size 和焦距有什么关系？

A:
- square-size 用于建立像素和真实世界的对应关系
- 焦距的计算依赖于这个对应关系
- 如果 square-size 错误，焦距也会错误
- 但焦距的单位是像素，不直接等于 square-size

## 总结

1. **square-size 是棋盘格方格的实际物理大小（毫米）**
2. **必须实际测量**，不能猜测
3. **设置错误会严重影响标定精度和后续测量**
4. **两个相机必须使用相同的 square-size**
5. **建议使用高精度工具测量，多次测量取平均**

正确设置 square-size 是获得准确标定结果的关键！

