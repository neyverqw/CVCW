# 双相机同步控制工具使用说明

## 功能概述

这个工具用于同时控制两个相机（Camera2 和 Camera4），支持：
- ✅ **同时拍照**：两个相机同步拍摄照片
- ✅ **同时录制视频**：两个相机同步录制视频
- ✅ **视频内嵌时间码**：自动在视频中显示时间戳和经过时间
- ✅ **同步信息保存**：自动保存同步信息和时间戳数据

## 快速开始

### 基本用法

```bash
# 使用默认设置（Camera2 和 Camera4）
python dual_camera_control.py
```

### 自定义相机ID

```bash
# 指定不同的相机ID
python dual_camera_control.py --camera1 0 --camera2 1
```

### 自定义相机名称

```bash
# 指定相机名称（用于文件命名）
python dual_camera_control.py \
    --name1 "BottomView" \
    --name2 "SideView"
```

### 自定义视频参数

```bash
# 设置分辨率和帧率
python dual_camera_control.py \
    --width 1920 \
    --height 1080 \
    --fps 30
```

## 完整参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `--camera1` | 2 | 第一个相机ID |
| `--camera2` | 4 | 第二个相机ID |
| `--name1` | Camera2 | 第一个相机名称 |
| `--name2` | Camera4 | 第二个相机名称 |
| `--width` | 1280 | 视频宽度（像素） |
| `--height` | 720 | 视频高度（像素） |
| `--fps` | 30 | 帧率 |

## 操作说明

### 键盘快捷键

| 按键 | 功能 |
|------|------|
| **`p`** | 同时拍照（两个相机同步拍摄） |
| **`r`** | 开始/停止录制视频 |
| **`i`** | 显示相机信息 |
| **`q`** | 退出程序 |

### 同时拍照

1. 按 `p` 键
2. 程序会倒计时 3 秒
3. 两个相机会同时拍摄照片
4. 照片保存在 `dual_camera_output/` 目录
5. 同时生成同步信息文件（JSON格式）

**输出文件**：
- `Camera2_20231215_143022_123.jpg`
- `Camera4_20231215_143022_123.jpg`
- `sync_20231215_143022_123.json`（同步信息）

### 同时录制视频

1. 按 `r` 键开始录制
2. 视频会自动内嵌时间码（显示在画面左上角）
3. 再次按 `r` 键停止录制
4. 视频保存在 `dual_camera_output/` 目录

**时间码显示**：
- **Time**: 当前日期时间（精确到毫秒）
- **Elapsed**: 从开始录制经过的时间（秒）

**输出文件**：
- `Camera2_20231215_143022.avi`
- `Camera4_20231215_143022.avi`
- `record_20231215_143022.json`（录制信息）
- `timestamps_20231215_143022.json`（每帧时间戳）

## 输出文件说明

### 照片文件

```
Camera2_20231215_143022_123.jpg  # 相机1的照片
Camera4_20231215_143022_123.jpg  # 相机2的照片
sync_20231215_143022_123.json    # 同步信息
```

**同步信息JSON格式**：
```json
{
  "timestamp": "20231215_143022_123",
  "camera1_file": "Camera2_20231215_143022_123.jpg",
  "camera2_file": "Camera4_20231215_143022_123.jpg",
  "datetime": "2023-12-15T14:30:22.123456"
}
```

### 视频文件

```
Camera2_20231215_143022.avi      # 相机1的视频（带时间码）
Camera4_20231215_143022.avi      # 相机2的视频（带时间码）
record_20231215_143022.json       # 录制信息
timestamps_20231215_143022.json  # 时间戳数据
```

**录制信息JSON格式**：
```json
{
  "start_time": "2023-12-15T14:30:22.123456",
  "camera1_file": "Camera2_20231215_143022.avi",
  "camera2_file": "Camera4_20231215_143022.avi",
  "fps": 30,
  "resolution1": [1280, 720],
  "resolution2": [1280, 720]
}
```

**时间戳数据JSON格式**：
```json
{
  "start_time": 1702632622.123456,
  "frame_timestamps": [
    {
      "frame_num": 0,
      "timestamp1": 1702632622.123456,
      "timestamp2": 1702632622.123457,
      "elapsed": 0.000,
      "datetime": "2023-12-15 14:30:22.123"
    },
    ...
  ],
  "total_frames": 900,
  "duration": 30.0
}
```

## 使用场景

### 场景1：任务3f - 双视角同步拍摄

```bash
# 设置相机名称
python dual_camera_control.py \
    --camera1 2 \
    --camera2 4 \
    --name1 "BottomView" \
    --name2 "SideView" \
    --fps 30

# 操作步骤：
# 1. 调整两个相机位置（底部视角和侧面视角）
# 2. 按 'r' 开始录制
# 3. 录制足够长的视频（建议30-60秒）
# 4. 按 'r' 停止录制
# 5. 按 'q' 退出
```

### 场景2：同步拍照测试

```bash
# 快速测试同步拍照
python dual_camera_control.py

# 操作：
# 1. 按 'p' 拍照
# 2. 检查输出目录中的照片和时间戳
# 3. 验证两个相机是否同步
```

## 时间码说明

### 时间码位置

时间码显示在视频画面的**左上角**，包含：

1. **Time**: 当前日期时间
   - 格式：`YYYY-MM-DD HH:MM:SS.mmm`
   - 示例：`2023-12-15 14:30:22.123`

2. **Elapsed**: 从开始录制经过的时间
   - 格式：`Elapsed: X.XXXs`
   - 示例：`Elapsed: 15.234s`

### 时间码特点

- ✅ **精确到毫秒**：时间戳精确到毫秒级别
- ✅ **同步显示**：两个视频的时间码完全同步
- ✅ **永久保存**：时间码直接嵌入视频，不会丢失
- ✅ **易于读取**：可以直接从视频中读取时间信息

### 使用时间码进行同步

两个视频的时间码是同步的，可以用于：

1. **帧对齐**：根据时间码找到对应的帧
2. **同步分析**：分析两个视角的同步性
3. **时间戳验证**：验证录制是否真正同步

## 注意事项

### 1. 相机连接

- 确保两个相机都已正确连接
- 使用 `test_cameras.py` 检测可用相机
- 如果相机ID不对，使用 `--camera1` 和 `--camera2` 参数指定

### 2. 存储空间

- 视频文件较大，确保有足够的存储空间
- 建议使用SSD或高速存储设备
- 录制前检查可用空间

### 3. 性能要求

- 双相机同时录制对系统性能要求较高
- 建议关闭其他占用资源的程序
- 如果帧率下降，可以降低分辨率或帧率

### 4. 同步精度

- 软件同步的精度取决于系统性能
- 对于高精度要求，建议使用硬件同步
- 时间码可以帮助验证同步精度

### 5. 文件格式

- 视频使用 AVI 格式（XVID 编码）
- 如果需要其他格式，可以后续转换
- 照片使用 JPG 格式

## 常见问题

### Q: 相机无法打开？

A: 
1. 检查相机ID是否正确
2. 使用 `test_cameras.py` 检测可用相机
3. 确保相机没有被其他程序占用
4. 检查相机驱动是否已安装

### Q: 录制时帧率很低？

A:
1. 降低分辨率（如 640x480）
2. 降低帧率（如 15 fps）
3. 关闭其他程序释放资源
4. 使用更快的存储设备

### Q: 两个视频不同步？

A:
1. 检查时间码是否一致
2. 查看 `timestamps_*.json` 文件中的时间戳
3. 如果差异较大，可能是系统性能问题
4. 考虑使用硬件同步

### Q: 如何播放带时间码的视频？

A:
- 使用任何视频播放器都可以看到时间码
- 时间码直接嵌入在视频画面中
- 可以使用 VLC、ffmpeg 等工具播放

### Q: 如何提取时间码信息？

A:
- 查看 `timestamps_*.json` 文件
- 使用视频处理工具（如 OpenCV）读取视频帧
- 从视频画面中OCR识别时间码（不推荐）

## 高级用法

### 批量拍照

可以修改代码添加批量拍照功能，或使用脚本循环调用：

```python
# 示例：连续拍摄10张照片
import time
# 在程序中按 'p' 键10次，每次间隔2秒
```

### 自定义时间码格式

可以修改 `add_timestamp()` 方法来自定义时间码显示格式。

### 添加其他功能

代码结构清晰，可以轻松添加：
- 自动对焦
- 曝光控制
- 白平衡调整
- 其他相机参数控制

## 输出目录结构

```
dual_camera_output/
├── Camera2_20231215_143022_123.jpg      # 照片
├── Camera4_20231215_143022_123.jpg      # 照片
├── sync_20231215_143022_123.json        # 同步信息
├── Camera2_20231215_143500.avi          # 视频
├── Camera4_20231215_143500.avi          # 视频
├── record_20231215_143500.json          # 录制信息
└── timestamps_20231215_143500.json      # 时间戳数据
```

## 与项目任务的结合

### 任务3f：双视角旋转周期估计

1. **准备**：
   ```bash
   python dual_camera_control.py \
       --camera1 2 --camera2 4 \
       --name1 "BottomView" --name2 "SideView"
   ```

2. **拍摄**：
   - 调整两个相机位置（底部和侧面）
   - 按 `r` 开始录制
   - 录制包含多个旋转周期的视频（30-60秒）
   - 按 `r` 停止录制

3. **分析**：
   - 使用保存的视频进行旋转周期分析
   - 使用时间码确保两个视角同步
   - 使用 `timestamps_*.json` 进行精确的时间对齐

## 总结

这个工具提供了完整的双相机同步控制功能，特别适合：
- ✅ 任务3f的双视角同步拍摄
- ✅ 需要时间同步的多相机应用
- ✅ 需要时间码记录的视频录制

所有功能都经过优化，确保两个相机尽可能同步，并提供详细的时间戳信息用于后续分析。

